<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dealer Permissions Matrix</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b46c1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'/%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'custom-purple': '#6b46c1',
              'custom-green': '#a3c293',
              'custom-gray': '#cccccc',
            }
          }
        }
      }
    </script>

    <!-- Import Map for React and Firebase -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "firebase/app": "https://esm.sh/firebase@10.8.0/app",
    "firebase/database": "https://esm.sh/firebase@10.8.0/database",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .transition-all-custom {
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 200ms;
      }
      .animate-pulse-green {
        animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse-green {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
      }
    </style>
  </head>
  <body class="bg-gray-50 text-slate-800 antialiased">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Check, X, RotateCcw, Cloud, CloudOff, Settings, Info } from 'lucide-react';
      import { initializeApp } from 'firebase/app';
      import { getDatabase, ref, set, onValue, get } from 'firebase/database';

      // --- Constants & Data Structure ---
      const DATA_COLUMNS = [
        "Initial Account Set Up", "Initial T&Cs", "Updated T&Cs", "At Check Out T&Cs",
        "Account Set Up", "T&Cs", "Updated T&Cs", "At Check Out T&Cs"
      ];

      const INITIAL_ROWS = [
        {
          id: 'dealer-new',
          category: 'Dealer Sponsored',
          subCategory: 'New Users',
          rowSpan: 2,
          isCategoryStart: true,
          initialValues: [true, true, true, true, true, true, true, true]
        },
        {
          id: 'dealer-legacy',
          category: 'Dealer Sponsored',
          subCategory: 'Legacy/Existing Users',
          isCategoryStart: false,
          initialValues: [false, false, false, false, false, false, false, false]
        },
        {
          id: 'electronic-fleet',
          category: 'Electronic Orders',
          subCategory: 'Fleet Customers/Impex',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [true, true, false, true, true, false, true, false]
        },
        {
          id: 'registered-guest',
          category: 'Registered',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, true, true, false, false, true, true, true]
        },
        {
          id: 'anonymous-guest',
          category: 'Anonymous',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, false, false, false, false, false, false, false]
        }
      ];

      const STORAGE_KEY_DATA = 'dealer_matrix_data_v1';
      const STORAGE_KEY_FIREBASE = 'dealer_matrix_firebase_config';

      // --- Storage Service ---
      const getDefaultState = () => {
        const defaults = {};
        INITIAL_ROWS.forEach(row => {
          row.initialValues.forEach((val, index) => {
            const cellId = `${row.id}-col-${index}`;
            defaults[cellId] = val;
          });
        });
        return defaults;
      };

      const loadLocalState = () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY_DATA);
          if (stored) return JSON.parse(stored);
          return getDefaultState();
        } catch (e) {
          console.error("Failed to load local state", e);
          return getDefaultState();
        }
      };

      const saveLocalState = (state) => {
        try {
          localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(state));
        } catch (e) {
          console.error("Failed to save local state", e);
        }
      };

      // --- Components ---
      const MatrixCell = ({ id, isActive, onToggle, disabled }) => {
        return (
          <td 
            onClick={() => !disabled && onToggle(id)}
            className={`border-r border-b border-gray-300 p-4 text-center align-middle transition-colors duration-200 ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-gray-50'}`}
          >
            <div className="flex flex-col items-center justify-center">
              {isActive ? (
                <Check className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
              ) : (
                <X className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
              )}
            </div>
          </td>
        );
      };

      const MatrixTable = ({ data, onToggle, disabled }) => {
        return (
          <div className="overflow-x-auto shadow-lg rounded-lg border border-gray-300 bg-white">
            <table className="w-full border-collapse min-w-[1000px]">
              <thead>
                <tr className="bg-gray-100">
                  <th className="border-r border-b border-gray-300 p-2 w-32 bg-gray-50"></th>
                  <th className="border-r border-b border-gray-300 p-2 w-48 bg-white"></th>
                  <th colSpan={4} className="border-r border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">
                    Single Dealer
                  </th>
                  <th colSpan={4} className="border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">
                    Multi-Dealer
                  </th>
                </tr>
                <tr className="bg-white">
                  <th className="border-r border-b border-gray-300 p-2"></th>
                  <th className="border-r border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top">
                    User Type
                  </th>
                  {DATA_COLUMNS.map((col, idx) => (
                    <th key={idx} className={`border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top w-28 ${idx < 7 ? 'border-r' : ''}`}>
                      {col}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {INITIAL_ROWS.map((row) => (
                  <tr key={row.id} className="hover:bg-gray-50/30">
                    {row.isCategoryStart && (
                      <td rowSpan={row.rowSpan || 1} className="border-r border-b border-gray-300 p-3 font-bold text-gray-800 align-top bg-white">
                        {row.category}
                      </td>
                    )}
                    <td className="border-r border-b border-gray-300 p-3 text-gray-700 align-top bg-white">
                      {row.subCategory}
                    </td>
                    {Array.from({ length: 8 }).map((_, colIndex) => {
                      const cellId = `${row.id}-col-${colIndex}`;
                      return (
                        <MatrixCell
                          key={cellId}
                          id={cellId}
                          isActive={!!data[cellId]}
                          onToggle={onToggle}
                          disabled={disabled}
                        />
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      };

      const ConfigModal = ({ isOpen, onClose, onSave, currentConfig }) => {
        const [configInput, setConfigInput] = useState('');

        useEffect(() => {
          if (isOpen && currentConfig) {
            setConfigInput(JSON.stringify(currentConfig, null, 2));
          }
        }, [isOpen, currentConfig]);

        const handleSave = () => {
          try {
            const parsed = JSON.parse(configInput);
            onSave(parsed);
            onClose();
          } catch (e) {
            alert("Invalid JSON format. Please ensure you pasted the entire config object from Firebase.");
          }
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
              <h2 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                <Cloud className="w-5 h-5 text-custom-purple" /> Setup Real-time Sync
              </h2>
              <p className="text-sm text-gray-600 mb-4">
                To enable Google Docs-style live syncing across multiple users, you need a free Firebase Realtime Database.
              </p>
              
              <ol className="list-decimal list-inside text-xs text-gray-500 mb-4 space-y-1 bg-gray-50 p-3 rounded">
                <li>Go to <a href="https://console.firebase.google.com" target="_blank" className="text-blue-600 hover:underline">console.firebase.google.com</a></li>
                <li>Create a project &gt; Build &gt; Realtime Database (Create in Test Mode).</li>
                <li>Go to Project Settings &gt; General &gt; "Your apps".</li>
                <li>Select Web &lt;/&gt;, register app, and copy the <code>firebaseConfig</code> object.</li>
              </ol>

              <textarea
                value={configInput}
                onChange={(e) => setConfigInput(e.target.value)}
                placeholder='Paste your firebaseConfig here: { "apiKey": "...", "authDomain": "...", ... }'
                className="w-full h-40 border border-gray-300 rounded p-2 text-xs font-mono mb-4 focus:ring-2 focus:ring-purple-500 outline-none"
              />

              <div className="flex justify-end gap-3">
                <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onClick={handleSave} className="px-4 py-2 text-sm bg-custom-purple text-white hover:bg-purple-700 rounded shadow-sm">Connect Cloud</button>
              </div>
            </div>
          </div>
        );
      };

      // --- Main App Component ---
      const App = () => {
        const [data, setData] = useState({});
        const [loading, setLoading] = useState(true);
        const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
        
        // Firebase State
        const [firebaseConfig, setFirebaseConfig] = useState(null);
        const [isFirebaseConnected, setIsFirebaseConnected] = useState(false);
        const [db, setDb] = useState(null);

        // Load Config & Initial Data
        useEffect(() => {
          // 1. Load Data
          const localData = loadLocalState();
          setData(localData);

          // 2. Load Config
          const storedConfig = localStorage.getItem(STORAGE_KEY_FIREBASE);
          if (storedConfig) {
            try {
              const config = JSON.parse(storedConfig);
              setFirebaseConfig(config);
              initializeFirebase(config);
            } catch (e) {
              console.error("Invalid stored config");
            }
          }

          setLoading(false);
        }, []);

        const initializeFirebase = (config) => {
          try {
            const app = initializeApp(config);
            const database = getDatabase(app);
            setDb(database);
            
            const dataRef = ref(database, 'dealer-matrix');
            
            // Listen for changes
            onValue(dataRef, (snapshot) => {
              const remoteData = snapshot.val();
              if (remoteData) {
                setData(remoteData);
                saveLocalState(remoteData); // Keep local backup synced
                setIsFirebaseConnected(true);
              } else {
                // If remote is empty, push local data
                set(dataRef, loadLocalState());
                setIsFirebaseConnected(true);
              }
            }, (error) => {
              console.error("Firebase error:", error);
              setIsFirebaseConnected(false);
            });

          } catch (e) {
            console.error("Firebase init failed:", e);
            setIsFirebaseConnected(false);
          }
        };

        const handleSaveConfig = (config) => {
          localStorage.setItem(STORAGE_KEY_FIREBASE, JSON.stringify(config));
          setFirebaseConfig(config);
          initializeFirebase(config);
          window.location.reload(); // Simple reload to ensure clean connection
        };

        const handleClearConfig = () => {
          if (confirm("Disconnect from cloud? You will return to local-only mode.")) {
            localStorage.removeItem(STORAGE_KEY_FIREBASE);
            setFirebaseConfig(null);
            setIsFirebaseConnected(false);
            setDb(null);
            window.location.reload();
          }
        };

        const handleToggle = (id) => {
          const newData = { ...data, [id]: !data[id] };
          
          // Optimistic update
          setData(newData);
          saveLocalState(newData);

          // Remote update
          if (db && isFirebaseConnected) {
            set(ref(db, 'dealer-matrix'), newData).catch(err => {
              console.error("Failed to push to cloud", err);
              alert("Sync error: Could not save to cloud.");
            });
          }
        };

        const handleReset = () => {
          if (window.confirm('Are you sure you want to reset all permissions to their default state?')) {
            const defaults = getDefaultState();
            setData(defaults);
            saveLocalState(defaults);
            
            if (db && isFirebaseConnected) {
              set(ref(db, 'dealer-matrix'), defaults);
            }
          }
        };

        if (loading) return <div className="flex h-screen items-center justify-center">Loading...</div>;

        return (
          <div className="min-h-screen bg-gray-50 flex flex-col">
            {/* Header */}
            <header className="bg-white border-b border-gray-200 px-6 py-4 shadow-sm sticky top-0 z-10">
              <div className="max-w-[1400px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                  <h1 className="text-xl font-bold text-gray-800">Dealer Permissions Matrix</h1>
                  <div className="flex items-center gap-2 mt-1">
                    {isFirebaseConnected ? (
                      <span className="flex items-center gap-1.5 text-sm font-medium text-green-600 bg-green-50 px-2 py-0.5 rounded-full border border-green-200">
                        <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse-green"></span>
                        Live Sync Active
                      </span>
                    ) : (
                      <span className="flex items-center gap-1.5 text-sm font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">
                        <span className="w-2 h-2 rounded-full bg-gray-400"></span>
                        Local Mode (Offline)
                      </span>
                    )}
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  {!isFirebaseConnected ? (
                    <button 
                      onClick={() => setIsConfigModalOpen(true)}
                      className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-custom-purple hover:bg-purple-700 rounded-md transition-colors shadow-sm"
                    >
                      <Cloud className="w-4 h-4" /> Setup Cloud Sync
                    </button>
                  ) : (
                    <button 
                      onClick={handleClearConfig}
                      className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors border border-gray-200"
                      title="Disconnect Cloud"
                    >
                      <CloudOff className="w-4 h-4" /> Disconnect
                    </button>
                  )}

                  <div className="w-px h-8 bg-gray-300 hidden md:block"></div>

                  <button 
                    onClick={handleReset}
                    className="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors border border-transparent hover:border-red-200"
                  >
                    <RotateCcw className="w-4 h-4" /> Reset
                  </button>
                </div>
              </div>
            </header>

            {/* Main Content */}
            <main className="flex-1 overflow-auto p-4 md:p-8">
              <div className="max-w-[1400px] mx-auto">
                <MatrixTable 
                  data={data} 
                  onToggle={handleToggle} 
                />
                
                <div className="mt-8 text-sm text-gray-400 text-center">
                  {!isFirebaseConnected ? (
                    <p>Currently in Local Mode. Changes are only saved on this device. <button onClick={() => setIsConfigModalOpen(true)} className="text-custom-purple hover:underline">Connect Cloud</button> to sync across devices.</p>
                  ) : (
                    <p>Cloud Mode Active. Changes are syncing in real-time to all connected devices.</p>
                  )}
                </div>
              </div>
            </main>

            {/* Config Modal */}
            <ConfigModal 
              isOpen={isConfigModalOpen} 
              onClose={() => setIsConfigModalOpen(false)} 
              onSave={handleSaveConfig}
              currentConfig={firebaseConfig}
            />
          </div>
        );
      };

      // --- Mount ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>