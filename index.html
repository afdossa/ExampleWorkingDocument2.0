<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dealer Permissions Matrix</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b46c1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'/%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'custom-purple': '#6b46c1',
              'custom-green': '#a3c293',
              'custom-gray': '#cccccc',
            }
          }
        }
      }
    </script>

    <!-- Import Map for React -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .transition-all-custom {
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 200ms;
      }
      .loader-dots:after {
        content: ' .';
        animation: dots 1s steps(5, end) infinite;
      }
      @keyframes dots {
        0%, 20% { content: ' .'; }
        40% { content: ' ..'; }
        60% { content: ' ...'; }
        80%, 100% { content: ''; }
      }
    </style>
  </head>
  <body class="bg-gray-50 text-slate-800 antialiased">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Check, X, RotateCcw, Github, Save, AlertCircle, CheckCircle2, Loader2 } from 'lucide-react';

      // --- Constants & Data Structure ---
      const DATA_COLUMNS = [
        "Initial Account Set Up", "Initial T&Cs", "Updated T&Cs", "At Check Out T&Cs",
        "Account Set Up", "T&Cs", "Updated T&Cs", "At Check Out T&Cs"
      ];

      const INITIAL_ROWS = [
        {
          id: 'dealer-new',
          category: 'Dealer Sponsored',
          subCategory: 'New Users',
          rowSpan: 2,
          isCategoryStart: true,
          initialValues: [true, true, true, true, true, true, true, true]
        },
        {
          id: 'dealer-legacy',
          category: 'Dealer Sponsored',
          subCategory: 'Legacy/Existing Users',
          isCategoryStart: false,
          initialValues: [false, false, false, false, false, false, false, false]
        },
        {
          id: 'electronic-fleet',
          category: 'Electronic Orders',
          subCategory: 'Fleet Customers/Impex',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [true, true, false, true, true, false, true, false]
        },
        {
          id: 'registered-guest',
          category: 'Registered',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, true, true, false, false, true, true, true]
        },
        {
          id: 'anonymous-guest',
          category: 'Anonymous',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, false, false, false, false, false, false, false]
        }
      ];

      const STORAGE_KEY_DATA = 'dealer_matrix_data_v1';
      const STORAGE_KEY_GITHUB = 'dealer_matrix_github_config';

      // --- Helper: Default State ---
      const getDefaultState = () => {
        const defaults = {};
        INITIAL_ROWS.forEach(row => {
          row.initialValues.forEach((val, index) => {
            const cellId = `${row.id}-col-${index}`;
            defaults[cellId] = val;
          });
        });
        return defaults;
      };

      // --- GitHub API Service ---
      const GITHUB_API_BASE = 'https://api.github.com';

      const fetchGitHubFile = async (token, owner, repo, path) => {
        const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}`;
        const headers = {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github.v3+json',
        };
        
        const response = await fetch(url, { headers, cache: 'no-store' });
        
        if (response.status === 404) return null; // File doesn't exist
        if (response.status === 401) throw new Error('Invalid GitHub Token');
        if (!response.ok) throw new Error('Failed to fetch from GitHub');
        
        const data = await response.json();
        // Decode Base64 content (handling UTF-8)
        const content = decodeURIComponent(escape(window.atob(data.content.replace(/\s/g, ''))));
        
        return {
          sha: data.sha,
          content: JSON.parse(content)
        };
      };

      const saveGitHubFile = async (token, owner, repo, path, content, sha) => {
        const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}`;
        
        // Encode content to Base64
        const contentStr = JSON.stringify(content, null, 2);
        const contentBase64 = window.btoa(unescape(encodeURIComponent(contentStr)));

        const body = {
          message: `Update matrix state [skip ci] - ${new Date().toISOString()}`,
          content: contentBase64,
          sha: sha // Needed to update existing file
        };

        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.message || 'Failed to save to GitHub');
        }

        const data = await response.json();
        return data.content.sha; // Return new SHA
      };

      // --- Components ---
      const MatrixCell = ({ id, isActive, onToggle, disabled }) => {
        return (
          <td 
            onClick={() => !disabled && onToggle(id)}
            className={`border-r border-b border-gray-300 p-4 text-center align-middle transition-colors duration-200 ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-gray-50'}`}
          >
            <div className="flex flex-col items-center justify-center">
              {isActive ? (
                <Check className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
              ) : (
                <X className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
              )}
            </div>
          </td>
        );
      };

      const MatrixTable = ({ data, onToggle, disabled }) => {
        return (
          <div className="overflow-x-auto shadow-lg rounded-lg border border-gray-300 bg-white">
            <table className="w-full border-collapse min-w-[1000px]">
              <thead>
                <tr className="bg-gray-100">
                  <th className="border-r border-b border-gray-300 p-2 w-32 bg-gray-50"></th>
                  <th className="border-r border-b border-gray-300 p-2 w-48 bg-white"></th>
                  <th colSpan={4} className="border-r border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">
                    Single Dealer
                  </th>
                  <th colSpan={4} className="border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">
                    Multi-Dealer
                  </th>
                </tr>
                <tr className="bg-white">
                  <th className="border-r border-b border-gray-300 p-2"></th>
                  <th className="border-r border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top">
                    User Type
                  </th>
                  {DATA_COLUMNS.map((col, idx) => (
                    <th key={idx} className={`border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top w-28 ${idx < 7 ? 'border-r' : ''}`}>
                      {col}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {INITIAL_ROWS.map((row) => (
                  <tr key={row.id} className="hover:bg-gray-50/30">
                    {row.isCategoryStart && (
                      <td rowSpan={row.rowSpan || 1} className="border-r border-b border-gray-300 p-3 font-bold text-gray-800 align-top bg-white">
                        {row.category}
                      </td>
                    )}
                    <td className="border-r border-b border-gray-300 p-3 text-gray-700 align-top bg-white">
                      {row.subCategory}
                    </td>
                    {Array.from({ length: 8 }).map((_, colIndex) => {
                      const cellId = `${row.id}-col-${colIndex}`;
                      return (
                        <MatrixCell
                          key={cellId}
                          id={cellId}
                          isActive={!!data[cellId]}
                          onToggle={onToggle}
                          disabled={disabled}
                        />
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      };

      const GitHubConfigModal = ({ isOpen, onClose, onSave, currentConfig }) => {
        const [token, setToken] = useState('');
        const [repo, setRepo] = useState('');
        const [path, setPath] = useState('matrix-data.json');

        useEffect(() => {
          if (isOpen && currentConfig) {
            setToken(currentConfig.token || '');
            setRepo(currentConfig.repo || '');
            setPath(currentConfig.path || 'matrix-data.json');
          }
        }, [isOpen, currentConfig]);

        const handleSave = () => {
          if(!token || !repo || !path) {
            alert("All fields are required.");
            return;
          }
          // Basic validation for repo format 'owner/repo'
          if(repo.indexOf('/') === -1) {
            alert("Repository must be in format 'owner/repo' (e.g. afdossa/ExampleWorkingDocument)");
            return;
          }
          onSave({ token, repo, path });
          onClose();
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
              <h2 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                <Github className="w-5 h-5 text-black" /> Connect to GitHub
              </h2>
              <p className="text-sm text-gray-600 mb-4">
                This will save the matrix state directly to a JSON file in your repository.
              </p>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-xs font-semibold text-gray-700 mb-1">GitHub Personal Access Token (Repo scope)</label>
                  <input 
                    type="password" 
                    value={token}
                    onChange={e => setToken(e.target.value)}
                    placeholder="ghp_xxxxxxxxxxxx"
                    className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-black outline-none"
                  />
                  <p className="text-[10px] text-gray-500 mt-1">Generate at Settings &gt; Developer settings &gt; Personal access tokens.</p>
                </div>

                <div>
                  <label className="block text-xs font-semibold text-gray-700 mb-1">Repository (Owner/Name)</label>
                  <input 
                    type="text" 
                    value={repo}
                    onChange={e => setRepo(e.target.value)}
                    placeholder="username/repository-name"
                    className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-black outline-none"
                  />
                </div>

                <div>
                  <label className="block text-xs font-semibold text-gray-700 mb-1">File Path</label>
                  <input 
                    type="text" 
                    value={path}
                    onChange={e => setPath(e.target.value)}
                    placeholder="data/matrix.json"
                    className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-black outline-none"
                  />
                </div>
              </div>

              <div className="flex justify-end gap-3 mt-6">
                <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onClick={handleSave} className="px-4 py-2 text-sm bg-black text-white hover:bg-gray-800 rounded shadow-sm">Save Configuration</button>
              </div>
            </div>
          </div>
        );
      };

      // --- Main App Component ---
      const App = () => {
        const [data, setData] = useState(getDefaultState());
        const [loading, setLoading] = useState(true);
        const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
        
        // GitHub State
        const [ghConfig, setGhConfig] = useState(null);
        const [fileSha, setFileSha] = useState(null);
        const [syncStatus, setSyncStatus] = useState('offline'); // offline, syncing, saved, error
        const [lastSavedTime, setLastSavedTime] = useState(null);

        // Debounce timer ref
        const saveTimeoutRef = useRef(null);

        // 1. Initial Load
        useEffect(() => {
          // Load local data first
          const localDataStr = localStorage.getItem(STORAGE_KEY_DATA);
          if (localDataStr) setData(JSON.parse(localDataStr));

          // Load GitHub config
          const storedConfig = localStorage.getItem(STORAGE_KEY_GITHUB);
          if (storedConfig) {
            const config = JSON.parse(storedConfig);
            setGhConfig(config);
            // Fetch remote data
            fetchRemoteData(config);
          } else {
            setLoading(false);
          }
        }, []);

        const fetchRemoteData = async (config) => {
          setSyncStatus('syncing');
          try {
            const result = await fetchGitHubFile(config.token, config.repo.split('/')[0], config.repo.split('/')[1], config.path);
            
            if (result) {
              setData(result.content);
              setFileSha(result.sha);
              // Update local cache
              localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(result.content));
              setLastSavedTime(new Date());
              setSyncStatus('saved');
            } else {
              // File doesn't exist yet, we will create it on first save
              setSyncStatus('saved'); // Technically "ready to save"
            }
          } catch (e) {
            console.error(e);
            setSyncStatus('error');
            if (e.message === 'Invalid GitHub Token') {
              alert("GitHub Token is invalid. Please update configuration.");
              setIsConfigModalOpen(true);
            }
          } finally {
            setLoading(false);
          }
        };

        const handleSaveConfig = (config) => {
          localStorage.setItem(STORAGE_KEY_GITHUB, JSON.stringify(config));
          setGhConfig(config);
          fetchRemoteData(config); // Initial fetch
        };

        const handleDisconnect = () => {
          if(confirm("Disconnect GitHub? The app will revert to local-only mode.")) {
            localStorage.removeItem(STORAGE_KEY_GITHUB);
            setGhConfig(null);
            setSyncStatus('offline');
            setFileSha(null);
          }
        };

        // --- Auto-Save Logic ---
        const triggerAutoSave = useCallback((newData) => {
          if (!ghConfig) return;

          // Clear existing timer
          if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);

          setSyncStatus('pending'); // Visual indicator: "Saving..."

          // Set new timer (Debounce 2 seconds)
          saveTimeoutRef.current = setTimeout(async () => {
            setSyncStatus('syncing');
            try {
              const [owner, repoName] = ghConfig.repo.split('/');
              
              // 1. Get latest SHA first (Concurrency check)
              // In a real robust app, we would merge. Here, we fetch SHA to avoid 409, 
              // effectively implementing "Last Write Wins".
              let currentSha = fileSha;
              try {
                const latest = await fetchGitHubFile(ghConfig.token, owner, repoName, ghConfig.path);
                if (latest) currentSha = latest.sha;
              } catch (e) { /* ignore fetch error, maybe file doesn't exist yet */ }

              // 2. Write file
              const newSha = await saveGitHubFile(ghConfig.token, owner, repoName, ghConfig.path, newData, currentSha);
              
              setFileSha(newSha);
              setLastSavedTime(new Date());
              setSyncStatus('saved');
            } catch (e) {
              console.error("Save failed", e);
              setSyncStatus('error');
            }
          }, 2000);
        }, [ghConfig, fileSha]);

        const handleToggle = (id) => {
          const newData = { ...data, [id]: !data[id] };
          
          // 1. Optimistic Update
          setData(newData);
          localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newData));

          // 2. Trigger Auto-save to GitHub
          triggerAutoSave(newData);
        };

        const handleReset = () => {
          if (window.confirm('Reset all permissions to default?')) {
            const defaults = getDefaultState();
            setData(defaults);
            localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(defaults));
            triggerAutoSave(defaults);
          }
        };

        // Helper for status UI
        const renderStatus = () => {
          if (syncStatus === 'offline') return <span className="text-gray-400 text-xs">Local Only</span>;
          if (syncStatus === 'syncing') return (
            <span className="flex items-center gap-1 text-blue-600 text-xs font-medium">
              <Loader2 className="w-3 h-3 animate-spin" /> Syncing...
            </span>
          );
          if (syncStatus === 'pending') return (
            <span className="flex items-center gap-1 text-amber-600 text-xs font-medium">
              <Loader2 className="w-3 h-3 animate-spin" /> Unsaved changes...
            </span>
          );
          if (syncStatus === 'error') return (
            <span className="flex items-center gap-1 text-red-600 text-xs font-medium" title="Check console or token">
              <AlertCircle className="w-3 h-3" /> Sync Error
            </span>
          );
          if (syncStatus === 'saved') return (
            <span className="flex items-center gap-1 text-green-600 text-xs font-medium">
              <CheckCircle2 className="w-3 h-3" /> Saved to GitHub {lastSavedTime ? `at ${lastSavedTime.toLocaleTimeString()}` : ''}
            </span>
          );
        };

        if (loading) return <div className="flex h-screen items-center justify-center">Loading...</div>;

        return (
          <div className="min-h-screen bg-gray-50 flex flex-col">
            {/* Header */}
            <header className="bg-white border-b border-gray-200 px-6 py-4 shadow-sm sticky top-0 z-10">
              <div className="max-w-[1400px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                  <h1 className="text-xl font-bold text-gray-800">Dealer Permissions Matrix</h1>
                  <div className="flex items-center gap-3 mt-1 h-5">
                    {renderStatus()}
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  {!ghConfig ? (
                    <button 
                      onClick={() => setIsConfigModalOpen(true)}
                      className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-md transition-colors shadow-sm"
                    >
                      <Github className="w-4 h-4" /> Connect GitHub
                    </button>
                  ) : (
                    <div className="flex items-center gap-3">
                      <span className="text-xs text-gray-400 font-mono hidden lg:block">{ghConfig.repo}/{ghConfig.path}</span>
                      <button 
                        onClick={handleDisconnect}
                        className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors border border-gray-200"
                      >
                        Disconnect
                      </button>
                    </div>
                  )}

                  <div className="w-px h-8 bg-gray-300 hidden md:block"></div>

                  <button 
                    onClick={handleReset}
                    className="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors border border-transparent hover:border-red-200"
                  >
                    <RotateCcw className="w-4 h-4" /> Reset
                  </button>
                </div>
              </div>
            </header>

            {/* Main Content */}
            <main className="flex-1 overflow-auto p-4 md:p-8">
              <div className="max-w-[1400px] mx-auto">
                <MatrixTable 
                  data={data} 
                  onToggle={handleToggle} 
                />
                
                <div className="mt-8 text-sm text-gray-400 text-center">
                  {!ghConfig ? (
                    <p>Local Mode. Connect GitHub to enable cross-device persistence.</p>
                  ) : (
                    <p>Connected to GitHub. Changes are committed automatically after 2 seconds of inactivity.</p>
                  )}
                </div>
              </div>
            </main>

            {/* Config Modal */}
            <GitHubConfigModal 
              isOpen={isConfigModalOpen} 
              onClose={() => setIsConfigModalOpen(false)} 
              onSave={handleSaveConfig}
              currentConfig={ghConfig}
            />
          </div>
        );
      };

      // --- Mount ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>