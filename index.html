<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dealer Permissions Matrix</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b46c1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'/%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'custom-purple': '#6b46c1',
              'custom-green': '#a3c293',
              'custom-gray': '#cccccc',
            }
          }
        }
      }
    </script>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "exceljs": "https://esm.sh/exceljs@4.4.0",
    "file-saver": "https://esm.sh/file-saver@2.0.5",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .transition-all-custom {
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 200ms;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-slate-800 antialiased">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Check, X, RotateCcw, FileSpreadsheet, Download } from 'lucide-react';
      import ExcelJS from 'exceljs';
      import FileSaver from 'file-saver';

      // --- Constants ---
      const DATA_COLUMNS = [
        "Initial Account Set Up", "Initial T&Cs", "Updated T&Cs", "At Check Out T&Cs",
        "Account Set Up", "T&Cs", "Updated T&Cs", "At Check Out T&Cs"
      ];

      const INITIAL_ROWS = [
        {
          id: 'dealer-new',
          category: 'Dealer Sponsored',
          subCategory: 'New Users',
          rowSpan: 2,
          isCategoryStart: true,
          initialValues: [true, true, true, true, true, true, true, true]
        },
        {
          id: 'dealer-legacy',
          category: 'Dealer Sponsored',
          subCategory: 'Legacy/Existing Users',
          isCategoryStart: false,
          initialValues: [false, false, false, false, false, false, false, false]
        },
        {
          id: 'electronic-fleet',
          category: 'Electronic Orders',
          subCategory: 'Fleet Customers/Impex',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [true, true, false, true, true, false, true, false]
        },
        {
          id: 'registered-guest',
          category: 'Registered',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, true, true, false, false, true, true, true]
        },
        {
          id: 'anonymous-guest',
          category: 'Anonymous',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, false, false, false, false, false, false, false]
        }
      ];

      const STORAGE_KEY = 'dealer_matrix_v2';

      // --- Helper: Excel Generator ---
      const generateExcel = async (currentData) => {
        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('Permissions Matrix', {
          views: [{ showGridLines: false }] // Clean look
        });

        // --- Styles ---
        const purpleColor = 'FF6B46C1';
        const grayBorderColor = 'FFD1D5DB';
        const headerBgColor = 'FFF3F4F6';
        
        const borderStyle = {
          top: { style: 'thin', color: { argb: grayBorderColor } },
          left: { style: 'thin', color: { argb: grayBorderColor } },
          bottom: { style: 'thin', color: { argb: grayBorderColor } },
          right: { style: 'thin', color: { argb: grayBorderColor } }
        };

        const fontHeader = { name: 'Arial', bold: true, size: 10, color: { argb: 'FF374151' } };
        const fontNormal = { name: 'Arial', size: 10, color: { argb: 'FF374151' } };
        const fontIcon = { name: 'Arial', size: 14, bold: true }; // Used for ✔/✘

        // --- Column Setup ---
        // A: Category, B: SubCategory, C-J: Data
        sheet.columns = [
          { width: 20 }, // Category
          { width: 25 }, // SubCategory
          { width: 15 }, { width: 15 }, { width: 15 }, { width: 15 }, // Single Dealer
          { width: 15 }, { width: 15 }, { width: 15 }, { width: 15 }  // Multi Dealer
        ];

        // --- Header Rows ---
        // Row 1: Group Headers
        sheet.getCell('C1').value = 'Single Dealer';
        sheet.mergeCells('C1:F1');
        sheet.getCell('G1').value = 'Multi-Dealer';
        sheet.mergeCells('G1:J1');

        ['C1', 'G1'].forEach(cellRef => {
          const cell = sheet.getCell(cellRef);
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE5E7EB' } }; // Darker gray for top header
          cell.font = fontHeader;
          cell.alignment = { horizontal: 'left', vertical: 'middle', indent: 1 };
          cell.border = borderStyle;
        });

        // Row 2: Column Headers
        sheet.getCell('B2').value = 'User Type';
        sheet.getCell('B2').font = fontNormal;
        sheet.getCell('B2').border = borderStyle;

        DATA_COLUMNS.forEach((colName, idx) => {
          const cell = sheet.getCell(2, idx + 3); // Start at C (3)
          cell.value = colName;
          cell.font = fontNormal;
          cell.alignment = { wrapText: true, vertical: 'top', horizontal: 'left' };
          cell.border = borderStyle;
        });

        // --- Data Rows ---
        let currentRowIdx = 3;

        INITIAL_ROWS.forEach((row) => {
          // Render Category (Merged if needed)
          if (row.isCategoryStart) {
            const startCell = `A${currentRowIdx}`;
            const endCell = `A${currentRowIdx + (row.rowSpan || 1) - 1}`;
            
            if (row.rowSpan > 1) {
              sheet.mergeCells(`${startCell}:${endCell}`);
            }
            
            const catCell = sheet.getCell(startCell);
            catCell.value = row.category;
            catCell.font = { ...fontHeader, size: 11 };
            catCell.alignment = { vertical: 'top', horizontal: 'left', indent: 1 };
            catCell.border = borderStyle;
            catCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
          }

          // Render SubCategory
          const subCell = sheet.getCell(`B${currentRowIdx}`);
          subCell.value = row.subCategory;
          subCell.font = fontNormal;
          subCell.alignment = { vertical: 'top', horizontal: 'left', indent: 1 };
          subCell.border = borderStyle;

          // Render Checkboxes
          for (let i = 0; i < 8; i++) {
            const cellId = `${row.id}-col-${i}`;
            const isChecked = !!currentData[cellId];
            const cell = sheet.getCell(currentRowIdx, i + 3);

            // Set Value
            cell.value = isChecked ? '✔' : '✘';
            
            // Set Alignment & Border
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
            cell.border = borderStyle;

            // Interactive Dropdown (Data Validation)
            // This replaces VBA for "Click to Change" in a safer way
            cell.dataValidation = {
              type: 'list',
              allowBlank: false,
              formulae: ['"✔,✘"'],
              showErrorMessage: true,
              errorTitle: 'Invalid Selection',
              error: 'Please select ✔ or ✘ from the dropdown.'
            };
          }

          currentRowIdx++;
        });

        // --- Conditional Formatting ---
        // This makes the colors change instantly when the user selects ✔ or ✘
        const dataRange = `C3:J${currentRowIdx - 1}`;
        
        // Rule 1: ✔ (Purple)
        sheet.addConditionalFormatting({
          ref: dataRange,
          rules: [
            {
              type: 'cellIs',
              operator: 'equal',
              formulae: ['"✔"'],
              style: {
                font: { color: { argb: purpleColor }, bold: true, size: 14 }
              }
            },
            {
              type: 'cellIs',
              operator: 'equal',
              formulae: ['"✘"'],
              style: {
                font: { color: { argb: purpleColor }, bold: true, size: 14 } // Keep same color to match app, or change to gray
              }
            }
          ]
        });

        // --- Finalize & Download ---
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        
        // Handle file-saver import quirks between default/named exports
        const saveAs = FileSaver.saveAs || FileSaver;
        saveAs(blob, `Dealer_Matrix_${new Date().toISOString().slice(0, 10)}.xlsx`);
      };


      // --- Helper: Local Storage ---
      const loadState = () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) return JSON.parse(stored);
        } catch(e) {}
        
        // Default State
        const defaults = {};
        INITIAL_ROWS.forEach(row => {
          row.initialValues.forEach((val, index) => {
            const cellId = `${row.id}-col-${index}`;
            defaults[cellId] = val;
          });
        });
        return defaults;
      };

      // --- Components ---
      const MatrixCell = ({ id, isActive, onToggle }) => (
        <td 
          onClick={() => onToggle(id)}
          className="border-r border-b border-gray-300 p-4 text-center align-middle cursor-pointer hover:bg-gray-50 transition-colors duration-200"
        >
          <div className="flex flex-col items-center justify-center">
            {isActive ? (
              <Check className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
            ) : (
              <X className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
            )}
          </div>
        </td>
      );

      // --- Main App ---
      const App = () => {
        const [data, setData] = useState({});
        const [isLoaded, setIsLoaded] = useState(false);

        useEffect(() => {
          setData(loadState());
          setIsLoaded(true);
        }, []);

        const handleToggle = (id) => {
          const newData = { ...data, [id]: !data[id] };
          setData(newData);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
        };

        const handleReset = () => {
          if (confirm('Reset to defaults?')) {
            localStorage.removeItem(STORAGE_KEY);
            setData(loadState()); // Reloads defaults
          }
        };

        if (!isLoaded) return <div className="flex h-screen items-center justify-center">Loading...</div>;

        return (
          <div className="min-h-screen bg-gray-50 flex flex-col">
            {/* Header */}
            <header className="bg-white border-b border-gray-200 px-6 py-4 shadow-sm sticky top-0 z-10">
              <div className="max-w-[1400px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                  <h1 className="text-xl font-bold text-gray-800">Dealer Permissions Matrix</h1>
                  <p className="text-sm text-gray-500 mt-1">Changes save to browser automatically.</p>
                </div>
                
                <div className="flex items-center gap-3">
                  <button 
                    onClick={() => generateExcel(data)}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors shadow-sm"
                    title="Download as interactive Excel file"
                  >
                    <FileSpreadsheet className="w-4 h-4" /> Download Excel App
                  </button>

                  <div className="w-px h-8 bg-gray-300 hidden md:block"></div>

                  <button 
                    onClick={handleReset}
                    className="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors border border-gray-200"
                  >
                    <RotateCcw className="w-4 h-4" /> Reset
                  </button>
                </div>
              </div>
            </header>

            {/* Main Content */}
            <main className="flex-1 overflow-auto p-4 md:p-8">
              <div className="max-w-[1400px] mx-auto">
                <div className="overflow-x-auto shadow-lg rounded-lg border border-gray-300 bg-white">
                  <table className="w-full border-collapse min-w-[1000px]">
                    <thead>
                      <tr className="bg-gray-100">
                        <th className="border-r border-b border-gray-300 p-2 w-32 bg-gray-50"></th>
                        <th className="border-r border-b border-gray-300 p-2 w-48 bg-white"></th>
                        <th colSpan={4} className="border-r border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">Single Dealer</th>
                        <th colSpan={4} className="border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">Multi-Dealer</th>
                      </tr>
                      <tr className="bg-white">
                        <th className="border-r border-b border-gray-300 p-2"></th>
                        <th className="border-r border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top">User Type</th>
                        {DATA_COLUMNS.map((col, idx) => (
                          <th key={idx} className={`border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top w-28 ${idx < 7 ? 'border-r' : ''}`}>{col}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {INITIAL_ROWS.map((row) => (
                        <tr key={row.id} className="hover:bg-gray-50/30">
                          {row.isCategoryStart && (
                            <td rowSpan={row.rowSpan || 1} className="border-r border-b border-gray-300 p-3 font-bold text-gray-800 align-top bg-white">{row.category}</td>
                          )}
                          <td className="border-r border-b border-gray-300 p-3 text-gray-700 align-top bg-white">{row.subCategory}</td>
                          {Array.from({ length: 8 }).map((_, colIndex) => (
                            <MatrixCell 
                              key={`${row.id}-col-${colIndex}`} 
                              id={`${row.id}-col-${colIndex}`} 
                              isActive={!!data[`${row.id}-col-${colIndex}`]} 
                              onToggle={handleToggle} 
                            />
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="mt-8 text-sm text-gray-500 text-center max-w-2xl mx-auto">
                  <p className="mb-2"><strong>Tip:</strong> Click "Download Excel App" to get an offline .xlsx file.</p>
                  <p className="text-xs text-gray-400">
                    The downloaded file uses Excel Data Validation (Dropdowns) instead of VBA macros. 
                    This allows it to work on mobile, web, and strict corporate networks without triggering "Security Risk" warnings, 
                    while still allowing you to change the checkmarks interactively.
                  </p>
                </div>
              </div>
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>