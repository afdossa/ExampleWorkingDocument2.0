<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dealer Permissions Matrix</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b46c1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'/%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'custom-purple': '#6b46c1',
              'custom-green': '#a3c293',
              'custom-gray': '#cccccc',
            }
          }
        }
      }
    </script>

    <!-- Import Map for React modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .transition-all-custom {
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 200ms;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-slate-800 antialiased">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Check, X, Shield, RotateCcw, Download, Upload, Link as LinkIcon, Copy } from 'lucide-react';

      // --- Constants & Data Structure ---
      const DATA_COLUMNS = [
        "Initial Account Set Up", "Initial T&Cs", "Updated T&Cs", "At Check Out T&Cs",
        "Account Set Up", "T&Cs", "Updated T&Cs", "At Check Out T&Cs"
      ];

      const INITIAL_ROWS = [
        {
          id: 'dealer-new',
          category: 'Dealer Sponsored',
          subCategory: 'New Users',
          rowSpan: 2,
          isCategoryStart: true,
          initialValues: [true, true, true, true, true, true, true, true]
        },
        {
          id: 'dealer-legacy',
          category: 'Dealer Sponsored',
          subCategory: 'Legacy/Existing Users',
          isCategoryStart: false,
          initialValues: [false, false, false, false, false, false, false, false]
        },
        {
          id: 'electronic-fleet',
          category: 'Electronic Orders',
          subCategory: 'Fleet Customers/Impex',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [true, true, false, true, true, false, true, false]
        },
        {
          id: 'registered-guest',
          category: 'Registered',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, true, true, false, false, true, true, true]
        },
        {
          id: 'anonymous-guest',
          category: 'Anonymous',
          subCategory: 'Guest Shopper',
          rowSpan: 1,
          isCategoryStart: true,
          initialValues: [false, false, false, false, false, false, false, false]
        }
      ];

      const STORAGE_KEY_DATA = 'dealer_matrix_data_v1';

      // --- Helper: State Compression for URL ---
      // We compress the boolean states into a hex string to make the URL shareable and short.
      const compressState = (data) => {
        let binaryString = '';
        INITIAL_ROWS.forEach(row => {
          for (let i = 0; i < 8; i++) {
            const cellId = `${row.id}-col-${i}`;
            binaryString += data[cellId] ? '1' : '0';
          }
        });
        // Convert binary to hex
        let hex = '';
        for (let i = 0; i < binaryString.length; i += 4) {
          const chunk = binaryString.substr(i, 4);
          hex += parseInt(chunk, 2).toString(16);
        }
        return hex;
      };

      const decompressState = (hex) => {
        if (!hex) return null;
        let binaryString = '';
        for (let i = 0; i < hex.length; i++) {
          const bin = parseInt(hex[i], 16).toString(2).padStart(4, '0');
          binaryString += bin;
        }

        const newState = {};
        let bitIndex = 0;
        
        INITIAL_ROWS.forEach(row => {
          for (let i = 0; i < 8; i++) {
            const cellId = `${row.id}-col-${i}`;
            if (bitIndex < binaryString.length) {
              newState[cellId] = binaryString[bitIndex] === '1';
              bitIndex++;
            }
          }
        });
        return newState;
      };

      // --- Storage Service ---
      const getDefaultState = () => {
        const defaults = {};
        INITIAL_ROWS.forEach(row => {
          row.initialValues.forEach((val, index) => {
            const cellId = `${row.id}-col-${index}`;
            defaults[cellId] = val;
          });
        });
        return defaults;
      };

      const loadMatrixState = () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY_DATA);
          if (stored) return JSON.parse(stored);
          return getDefaultState();
        } catch (e) {
          console.error("Failed to load state", e);
          return getDefaultState();
        }
      };

      const saveMatrixState = (state) => {
        try {
          localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(state));
        } catch (e) {
          console.error("Failed to save state", e);
        }
      };

      // --- Components ---
      const MatrixCell = ({ id, isActive, onToggle }) => {
        return (
          <td 
            onClick={() => onToggle(id)}
            className="border-r border-b border-gray-300 p-4 text-center align-middle cursor-pointer hover:bg-gray-50 transition-colors duration-200"
          >
            <div className="flex flex-col items-center justify-center">
              {isActive ? (
                <Check className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
              ) : (
                <X className="w-8 h-8 text-custom-purple font-bold stroke-[3]" />
              )}
            </div>
          </td>
        );
      };

      const MatrixTable = ({ data, onToggle }) => {
        return (
          <div className="overflow-x-auto shadow-lg rounded-lg border border-gray-300 bg-white">
            <table className="w-full border-collapse min-w-[1000px]">
              <thead>
                <tr className="bg-gray-100">
                  <th className="border-r border-b border-gray-300 p-2 w-32 bg-gray-50"></th>
                  <th className="border-r border-b border-gray-300 p-2 w-48 bg-white"></th>
                  <th colSpan={4} className="border-r border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">
                    Single Dealer
                  </th>
                  <th colSpan={4} className="border-b border-gray-300 p-3 text-left font-bold text-gray-800 bg-gray-200/50">
                    Multi-Dealer
                  </th>
                </tr>
                <tr className="bg-white">
                  <th className="border-r border-b border-gray-300 p-2"></th>
                  <th className="border-r border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top">
                    User Type
                  </th>
                  {DATA_COLUMNS.map((col, idx) => (
                    <th key={idx} className={`border-b border-gray-300 p-3 text-left font-normal text-gray-600 align-top w-28 ${idx < 7 ? 'border-r' : ''}`}>
                      {col}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {INITIAL_ROWS.map((row) => (
                  <tr key={row.id} className="hover:bg-gray-50/30">
                    {row.isCategoryStart && (
                      <td rowSpan={row.rowSpan || 1} className="border-r border-b border-gray-300 p-3 font-bold text-gray-800 align-top bg-white">
                        {row.category}
                      </td>
                    )}
                    <td className="border-r border-b border-gray-300 p-3 text-gray-700 align-top bg-white">
                      {row.subCategory}
                    </td>
                    {Array.from({ length: 8 }).map((_, colIndex) => {
                      const cellId = `${row.id}-col-${colIndex}`;
                      return (
                        <MatrixCell
                          key={cellId}
                          id={cellId}
                          isActive={!!data[cellId]}
                          onToggle={onToggle}
                        />
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      };

      // --- Main App Component ---
      const App = () => {
        const [data, setData] = useState({});
        const [loading, setLoading] = useState(true);
        const [notification, setNotification] = useState(null);
        const fileInputRef = useRef(null);

        // 1. Load Data on Mount (Check URL first, then LocalStorage)
        useEffect(() => {
          // Check for ?s= HEX string in URL
          const params = new URLSearchParams(window.location.search);
          const urlStateHex = params.get('s');
          
          if (urlStateHex) {
            const decodedData = decompressState(urlStateHex);
            if (decodedData) {
              setData(decodedData);
              saveMatrixState(decodedData);
              // Clean URL
              window.history.replaceState({}, '', window.location.pathname);
              showNotification('State loaded from Shared Link!', 'success');
              setLoading(false);
              return;
            }
          }

          // Fallback to LocalStorage
          const savedData = loadMatrixState();
          setData(savedData);
          setLoading(false);
        }, []);

        // Notification Helper
        const showNotification = (msg, type = 'info') => {
          setNotification({ msg, type });
          setTimeout(() => setNotification(null), 3000);
        };

        const handleToggle = (id) => {
          const newData = { ...data, [id]: !data[id] };
          setData(newData);
          saveMatrixState(newData);
        };

        const handleReset = () => {
          if (window.confirm('Are you sure you want to reset all permissions to their default state?')) {
            localStorage.removeItem(STORAGE_KEY_DATA);
            const defaults = getDefaultState();
            setData(defaults);
            saveMatrixState(defaults);
            showNotification('Reset to defaults.');
          }
        };

        // --- JSON Export/Import ---
        const handleDownloadJson = () => {
          const jsonString = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `dealer-matrix-${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showNotification('Config downloaded!');
        };

        const handleUploadClick = () => {
          fileInputRef.current?.click();
        };

        const handleFileChange = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const importedData = JSON.parse(event.target.result);
              // Basic validation could go here
              setData(importedData);
              saveMatrixState(importedData);
              showNotification('Config imported successfully!', 'success');
            } catch (err) {
              alert('Invalid JSON file');
            }
          };
          reader.readAsText(file);
          // Reset input
          e.target.value = '';
        };

        // --- Link Sharing ---
        const handleCopyLink = () => {
          const hex = compressState(data);
          const url = `${window.location.origin}${window.location.pathname}?s=${hex}`;
          navigator.clipboard.writeText(url).then(() => {
            showNotification('Shareable Link copied to clipboard!', 'success');
          });
        };

        if (loading) return <div className="flex h-screen items-center justify-center">Loading...</div>;

        return (
          <div className="min-h-screen bg-gray-50 flex flex-col">
            {/* Header */}
            <header className="bg-white border-b border-gray-200 px-6 py-4 shadow-sm sticky top-0 z-10">
              <div className="max-w-[1400px] mx-auto flex flex-col xl:flex-row justify-between items-center gap-4">
                <div>
                  <h1 className="text-xl font-bold text-gray-800">Dealer Permissions Matrix</h1>
                  <p className="text-sm text-gray-500 mt-1">Admin Mode â€¢ Changes auto-save locally</p>
                </div>
                
                <div className="flex flex-wrap gap-2 justify-center">
                  <button 
                    onClick={handleCopyLink}
                    className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-custom-purple bg-purple-50 hover:bg-purple-100 rounded-md transition-colors border border-purple-200"
                    title="Copy a link that contains the current state"
                  >
                    <LinkIcon className="w-4 h-4" /> Share Link
                  </button>

                  <button 
                    onClick={handleDownloadJson}
                    className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 rounded-md transition-colors border border-gray-300"
                    title="Download JSON file"
                  >
                    <Download className="w-4 h-4" /> Save JSON
                  </button>

                  <button 
                    onClick={handleUploadClick}
                    className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 rounded-md transition-colors border border-gray-300"
                    title="Upload JSON file"
                  >
                    <Upload className="w-4 h-4" /> Load JSON
                  </button>
                  <input 
                    type="file" 
                    ref={fileInputRef} 
                    onChange={handleFileChange} 
                    accept=".json" 
                    className="hidden" 
                  />

                  <div className="w-px h-8 bg-gray-300 mx-2 hidden md:block"></div>

                  <button 
                    onClick={handleReset}
                    className="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors border border-transparent hover:border-red-200"
                  >
                    <RotateCcw className="w-4 h-4" /> Reset
                  </button>
                </div>
              </div>
            </header>

            {/* Notification Toast */}
            {notification && (
              <div className={`fixed top-20 right-6 z-50 px-4 py-3 rounded shadow-lg text-white text-sm font-medium animate-bounce ${notification.type === 'success' ? 'bg-green-600' : 'bg-gray-800'}`}>
                {notification.msg}
              </div>
            )}

            {/* Main Content */}
            <main className="flex-1 overflow-auto p-4 md:p-8">
              <div className="max-w-[1400px] mx-auto">
                <MatrixTable data={data} onToggle={handleToggle} />
                
                <div className="mt-8 text-sm text-gray-400 text-center flex flex-col gap-2">
                  <p>To persist data across devices, use the "Share Link" or "Save JSON" buttons above.</p>
                </div>
              </div>
            </main>
          </div>
        );
      };

      // --- Mount ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>